version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws --version
      - docker login -u AWS -p eyJwYXlsb2FkIjoibEQ0UlNoUWVuN0dJdkhaQWw2MGdoeHRhaDlGQlZpdU1Ed3ZZR2VPcDRqSU9VU2NXM2twY3FVbkNFdTg4OXpjcm50VE1ienNJNzI1SjBmUHhkSHA1dTlyZ01CVGt5a01RZm5xMkFnTkp6V0RoY29rN2pIYzZ6bEZib0ZERGN6T0JpSitvYVNzM2RYdmdvREJkMngxS0Q2YWxBZWZBZlplQnFsNDZrbkw2N24zQjZPc3RtRkc1blJqS05tdmthMEJIbXJSR0tkSEZINDI2RXdMcndVVUszT2FmcWI5c0JiU2ZPNFh4Ykx3QkRBMUVFU2ZrZzNKVzNYOEhrMEZZOEZaUzdUdWErbnBnTk5JMFRSZFYwWm1UVllUd2ZWMzJNV0RKNTMrbEx3RUx6UzBrbEVEaC9xdm1lL2VuMi9NUnIyMU1qVU9KR01nZ2lueHArQ1MxT0FxMFpHOC90aDA0enZDSkNtQTdieVo2OGZjdGFzTGhGdTRDVTFRWGpxeHJWZGZDTlY1cEFzUlROQjFDS3dLMFBRcHNvdTh5RFZXeFl5Rmx2eS81bmFFSXROZGZtckZLS1R4NUJXSnE2R2gwRXdsWENIaUVIQlZSWU5ocnA5UE5waFB3V0U5Q0drdU1rNEdvelRPcXRzb2FXOUIveVM4ZTVGN09lYzFDL0cxM0V0bFhGdzdTdTl5dE9US3FFRmhaUFJQZjdxTE1GN2wzUnl6Zk9rK0tmMC9VdmFud0dYQk5la3pjS1ZWR2M5c2tRZkJvRVBHR2pPQkZYVnhGaXphNG9wQWw1L0VrcDdjSFRuZnltd1JlT096Z3VRT0F2N3ZYUk9KaW1TWkFMWUw1MmZaN1VVNGorU0hFU3VyK0lUWUFhZ2xOdGNsRDdwU3Y4QlMyNU9iV0xOMmdRV0UvenVKelY1RjRHZENxcncremd2eGlrcU9VMGRrSXF2QmpIdmYyd2c5bm1VeVh4di9lbTBoeVM5RGlZOHFEQllDY3BBNXQwMG12RGgxK3lvbHdsQ3U1NE4wK0hYOWorNXMvalc5eFpzdUExWDJienVwVnVMUmhzVTNmbGoxR0F6SkgzdkpuTE9uRGlwUmV4NUNQbFlySUtzU3M4cEZwVFprK2Z4MUpleUxMenVOS3NNazZYVFh6dWxSNGhqc2REckhzZytxWGhQS3ppSjJLYzJOSFNDei9lNzErdW9BWWp3ekVRTzFqelpsMDFsRXowektrOEVzTHQzS2ZNUVJHUVoyTVdlcThaU3BuQjlOSVNVRm9kd1ZPc2t4dXp1YXo0NTlaVlNVb0FQTlE2a3A3VzdiYzEzdWRoUkExL3RBZFkrdWNqRzNmV3NlSm9CVk5WR0wvMDlLbGtzNnFXL3pwWkV2aEJMa3VDaVAzdWpVWkY0cmFIb2VwU2ZnNDFndHA5YkYrS3E1RURUenNmQnJzK1FlSG00NFc3QjFidUJpMmhCTThJYWJsUlRQazk2dmYvSW4xMVE9PSIsImRhdGFrZXkiOiJBUUVCQUhod20wWWFJU0plUnRKbTVuMUc2dXFlZWtYdW9YWFBlNVVGY2U5UnE4LzE0d0FBQUg0d2ZBWUpLb1pJaHZjTkFRY0dvRzh3YlFJQkFEQm9CZ2txaGtpRzl3MEJCd0V3SGdZSllJWklBV1VEQkFFdU1CRUVESnZJeTBVbjFHRFF2Vy9GNlFJQkVJQTdYYnBKaURVZnpJV1BYV2dyT05IV2hJNmc5ZE9JczlWbTFackQvVkE0QlMwWGprY3NlSWM0UUpNYVVLTXUyWWhpbDdNOUpWU1hMRHZ2R2hFPSIsInZlcnNpb24iOiIyIiwidHlwZSI6IkRBVEFfS0VZIiwiZXhwaXJhdGlvbiI6MTUzMzQwNjczNn0= https://255775243622.dkr.ecr.us-east-1.amazonaws.com
      - REPOSITORY_URI=255775243622.dkr.ecr.us-east-1.amazonaws.com/next-test
      - IMAGE_TAG=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | cut -c 1-7)
  build:
    commands:
      - echo Build started on `date`
      - echo Building the Docker image...
      - docker build -t $REPOSITORY_URI:latest .
      - docker tag $REPOSITORY_URI:latest $REPOSITORY_URI:$IMAGE_TAG
  post_build:
    commands:
      - echo Build completed on `date`
      - echo Pushing the Docker images...
      - docker push $REPOSITORY_URI:latest
      - docker push $REPOSITORY_URI:$IMAGE_TAG
      - echo Writing image definitions file...
      - printf '[{"name":"next-test","imageUri":"%s"}]' $REPOSITORY_URI:$IMAGE_TAG > imagedefinitions.json
artifacts:
    files: imagedefinitions.json